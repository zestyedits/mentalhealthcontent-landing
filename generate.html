<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Generate — MentalHealthContent.ai</title>
  <meta name="description" content="Generate client-friendly mental-health content with AI. Export text or DOCX.">

  <!-- Same design tokens and styles as index.html -->
  <style>
    :root {
      --bg: #0b1022;
      --panel: #0e1436;
      --muted: #c7d2fe;
      --text: #eef2ff;
      --accent: #8b5cf6; /* violet */
      --accent-2: #06b6d4; /* cyan */
      --card: #0a0f2b;
      --border: #1b2161;
      --ring: rgba(139,92,246,.35);
    }
    [data-theme="vibrant"] {
      --bg: #0a0a1f;
      --panel: #0e1329;
      --muted: #ffe4e6;
      --text: #fff1f2;
      --accent: #f97316; /* orange */
      --accent-2: #ec4899; /* pink */
      --card: #0c1028;
      --border: #30215e;
      --ring: rgba(236,72,153,.35);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text);
      line-height: 1.5;
      background: radial-gradient(1000px 600px at 10% -10%, color-mix(in oklab, var(--accent) 40%, transparent), transparent 60%),
                  radial-gradient(900px 500px at 90% 10%, color-mix(in oklab, var(--accent-2) 40%, transparent), transparent 60%),
                  linear-gradient(180deg, var(--bg), #0b0f24 50%, var(--panel) 120%);
    }
    a { color: var(--accent-2); text-decoration: none; }
    a:hover { text-decoration: underline; }

    /* Header (identical to index.html) */
    .container { width: 100%; max-width: 1100px; margin: 0 auto; padding: 0 1rem; }
    header {
      position: sticky; top: 0; z-index: 50; backdrop-filter: saturate(140%) blur(8px);
      background: rgba(11, 18, 32, 0.7); border-bottom: 1px solid var(--border);
    }
    .nav { display: flex; align-items: center; justify-content: space-between; padding: 0.9rem 0; }
    .brand { display: flex; align-items: center; gap: .6rem; font-weight: 700; letter-spacing: .2px; }
    .brand svg { width: 28px; height: 28px; }
    .menu { display: flex; gap: 1rem; align-items: center; }
    .menu a { color: var(--text); opacity: 0.9; font-size: .95rem; }
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: .5rem;
      border: 1px solid var(--border); background: #101826; color: var(--text);
      padding: .65rem .95rem; border-radius: .75rem; font-weight: 600; cursor: pointer;
      transition: transform .04s ease, box-shadow .2s ease;
    }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(0,0,0,.25); }
    .btn.primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      border-color: transparent; color: #0a0a0a;
      box-shadow: 0 0 0 2px var(--ring), 0 8px 24px rgba(0,0,0,.35);
    }
    .btn.primary:hover { transform: translateY(-2px) scale(1.01); }
    .btn.ghost { background: transparent; }

    /* Hero */
    .hero { padding: 2.75rem 0 1.25rem; }
    .hero h1 {
      font-size: clamp(1.9rem, 2.4vw + 1rem, 2.8rem);
      line-height: 1.12; margin: .25rem 0 .5rem;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      -webkit-background-clip: text; background-clip: text; color: transparent;
    }
    .meta { color: var(--muted); font-size: .95rem; }
    .pill {
      display: inline-block; font-size: .75rem; letter-spacing: .2px; border: 1px solid transparent;
      color: #0a0a0a; padding: .32rem .6rem; border-radius: 999px;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
    }

    /* Cards + layout (match index) */
    .card {
      background: linear-gradient(180deg, rgba(167,139,250,.08), rgba(34,211,238,.06)), var(--card);
      border: 1px solid var(--border); border-radius: 1rem; padding: 1rem;
      transition: transform .15s ease, box-shadow .2s ease, border-color .2s ease;
    }
    .card:hover { transform: translateY(-2px); border-color: color-mix(in hsl, var(--accent) 30%, var(--border)); box-shadow: 0 10px 30px rgba(0,0,0,.35); }

    .studio { display: grid; gap: 1rem; margin: 1rem 0 2rem; align-items: start; }
    @media (min-width: 980px) { .studio { grid-template-columns: 390px minmax(0,1fr); } }

    .rail h3, .canvas h3 { margin: .2rem 0 .6rem; font-size: 1.05rem; }
    label { display:block; font-weight:600; margin:.4rem 0 .35rem; }
    input, select, textarea {
      width:100%; background:#0c1424; color:var(--text);
      border:1px solid var(--border); border-radius:.7rem; padding:.7rem .85rem; outline:none;
      transition: border-color .2s ease, box-shadow .2s ease; font-size:1rem;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #5b7fff;
      box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent) 25%, transparent);
    }
    .actions { display:flex; gap:.6rem; flex-wrap:wrap; align-items:center; }
    .right { margin-left:auto; color: var(--muted); font-size:.9rem; }

    .out { border:1px solid var(--border); background:#0c1424; border-radius:.7rem; padding:.9rem; max-height:60vh; overflow:auto; }
    pre { margin:0; white-space:pre-wrap; word-wrap:break-word; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:.95rem; line-height:1.6; max-width: 72ch; }

    footer { border-top: 1px solid var(--border); padding: 2rem 0; color: var(--muted); font-size: .9rem; margin-top:.5rem; }
    .micro { font-size:.9rem; color: var(--muted); }
  </style>

  <!-- DOCX generator (client-side) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.3.2/docx.umd.min.js" defer></script>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="container nav">
      <div class="brand" aria-label="MentalHealthContent.ai home">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M12 21s-6-3.8-9-7.1C1 12 1 9.5 2.7 7.8c1.6-1.6 4.3-1.5 6 0L12 9l3.3-1.2c1.7-1.5 4.4-1.6 6 0C22 9.5 22 12 21 13.9 18 17.2 12 21 12 21z" fill="url(#g)"/>
          <defs><linearGradient id="g" x1="0" y1="0" x2="24" y2="24"><stop stop-color="#22c55e"/><stop offset="1" stop-color="#06b6d4"/></linearGradient></defs>
        </svg>
        <span>MentalHealthContent.ai</span>
      </div>
      <nav class="menu" aria-label="primary">
        <a href="/#examples">Examples</a>
        <a href="/#prompts">Free Prompts</a>
        <a href="/#pricing">Pricing</a>
        <a href="/#faq">FAQ</a>
        <a class="btn ghost" href="https://app.mentalhealthcontent.ai">Sign in</a>
        <a class="btn primary" href="/#start">Start free</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- Hero -->
    <section class="hero">
      <h1>Generate client-friendly content</h1>
      <p class="meta">
        Start with a topic and format. You’ll get a clean, copy-ready draft. Export as text or DOCX.
        <em> Educational use only.</em>
        <span id="creditPill" class="pill" style="margin-left:.5rem">Free credits left: 2</span>
      </p>
    </section>

    <!-- Studio -->
    <section class="studio">
      <!-- Left: inputs -->
      <div class="card rail">
        <h3>Your request</h3>
        <form id="genForm">
          <label for="topic">Topic</label>
          <input id="topic" name="topic" placeholder="5-4-3-2-1 grounding for teens" value="DBT Skills for Teens" />

          <label for="format" style="margin-top:.7rem;">Format</label>
          <select id="format" name="format">
            <option value="carousel">Instagram carousel</option>
            <option value="worksheet" selected>Worksheet outline</option>
            <option value="video">60s video script</option>
            <option value="blog">Blog outline</option>
          </select>

          <div class="actions" style="margin-top:.8rem">
            <button class="btn primary" type="submit" id="btnGenerate">Generate</button>
            <button class="btn" type="button" id="btnSample">Use sample</button>
            <span class="right" id="status"></span>
          </div>

          <p class="micro" style="margin:.6rem 0 0">
            Calls <code>POST /api/generate</code> with <code>{ topic, format }</code>.
          </p>
        </form>

        <hr style="border:none;border-top:1px solid var(--border); margin:1rem 0">
        <div class="actions" style="gap:.5rem">
          <button class="btn" id="btnDocx" title="Sign in to export DOCX" disabled>Generate & Download DOCX</button>
          <button class="btn" id="btnCopy" disabled>Copy output</button>
        </div>
      </div>

      <!-- Right: output -->
      <div class="card canvas" aria-live="polite">
        <h3>Output</h3>
        <div class="out"><pre id="out">Run a generation to see output…</pre></div>
      </div>
    </section>
  </main>

  <footer>
    <div class="container">
      <div>MentalHealthContent.ai • Built by a licensed clinician • © <span id="yr"></span></div>
      <div style="margin-top:.5rem">Educational use only. Not for crisis or emergency use. <a href="#">Terms</a> · <a href="#">Privacy</a> · <a href="#">Contact</a></div>
    </div>
  </footer>

  <script>
    // Footer year
    document.getElementById('yr').textContent = new Date().getFullYear();

    // --- Trial credits (temporary client-side until backend) ---
    const TRIAL_KEY = 'mhc_trial_uses_v1';
    const MAX_FREE = 2; // free generations without account
    function getTrialUses(){ return Number(localStorage.getItem(TRIAL_KEY) || 0); }
    function incTrialUses(){ localStorage.setItem(TRIAL_KEY, String(getTrialUses() + 1)); }
    function remainingFree(){ return Math.max(0, MAX_FREE - getTrialUses()); }
    function updateCreditPill(){
      const pill = document.getElementById('creditPill');
      if (pill) pill.textContent = `Free credits left: ${remainingFree()}`;
    }
    // If they came via /generate?trial=1, focus topic
    (function initTrial(){
      updateCreditPill();
      const url = new URL(location.href);
      if (url.searchParams.get('trial') === '1') {
        document.getElementById('topic').focus();
      }
    })();

    // Elements
    const form = document.getElementById('genForm');
    const topic = document.getElementById('topic');
    const formatSel = document.getElementById('format');
    const statusEl = document.getElementById('status');
    const out = document.getElementById('out');
    const copyBtn = document.getElementById('btnCopy');
    const sampleBtn = document.getElementById('btnSample');
    const genBtn = document.getElementById('btnGenerate');
    const docxBtn = document.getElementById('btnDocx');

    function setStatus(msg){ statusEl.textContent = msg || ''; }
    function setOut(text){
      out.textContent = text || '';
      copyBtn.disabled = !out.textContent.trim();
    }

    sampleBtn.addEventListener('click', () => {
      topic.value = "5-4-3-2-1 grounding for teens";
      formatSel.value = "carousel";
      topic.focus();
    });

    copyBtn.addEventListener('click', async () => {
      try{
        await navigator.clipboard.writeText(out.textContent || "");
        const old = copyBtn.textContent; copyBtn.textContent = "Copied!";
        setTimeout(()=> copyBtn.textContent = old, 1000);
      }catch(e){}
    });

    // Anonymous gating: if out of free credits, lock the Generate button and nudge to sign up
    function enforceTrialGate(){
      if (remainingFree() === 0){
        genBtn.disabled = true;
        genBtn.textContent = 'Create a free account to keep going';
        genBtn.onclick = () => location.href = 'https://app.mentalhealthcontent.ai/signup';
      }
    }
    enforceTrialGate();

    async function runGeneration(payload){
      if (remainingFree() === 0){
        enforceTrialGate();
        return null;
      }

      setStatus("Generating…"); setOut("");
      try{
        const res = await fetch('/api/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if(!res.ok){
          const txt = await res.text();
          setOut(`Error ${res.status}: ${txt || 'Request failed'}`);
          return null;
        }
        const data = await res.json();
        const text = data.output || data.error || data.debug || '';
        setOut(text || 'No output');

        if (text){
          incTrialUses();
          updateCreditPill();
          enforceTrialGate();
        }
        return text || '';
      }catch(err){
        setOut('Fetch error: ' + err.message);
        return null;
      }finally{
        setStatus("");
      }
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const payload = { topic: topic.value?.trim(), format: formatSel.value };
      if(!payload.topic){ topic.focus(); return; }
      await runGeneration(payload);
    });

    // --- DOCX export (gated for sign-in; robust loader; fallback to .txt) ---
    function waitForDocx(ms=8000){
      return new Promise((resolve, reject) => {
        const t0 = Date.now();
        (function poll(){
          if (window.docx && window.docx.Document) return resolve(window.docx);
          if (Date.now() - t0 > ms) return reject(new Error("DOCX library not available (blocked by CSP/adblock?)"));
          requestAnimationFrame(poll);
        })();
      });
    }
    function downloadBlob(blob, filename){
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob); a.download = filename;
      document.body.appendChild(a); a.click(); URL.revokeObjectURL(a.href); a.remove();
    }

    // NOTE: Keep DOCX disabled for anonymous users until you wire real auth.
    // (If you want to allow DOCX during the 2 free tries, just remove 'disabled' from the button and next line.)
    docxBtn.addEventListener('click', async () => {
      // In production, check user session here instead of simple disable.
      if (docxBtn.disabled) {
        alert('Sign in to export DOCX.');
        location.href = 'https://app.mentalhealthcontent.ai/login';
        return;
      }
    });

    // If you later decide to allow DOCX in trial, use the handler below instead and remove the above listener & disabled attr.
    // function enableDocxExport(){
    //   docxBtn.disabled = false; docxBtn.title = '';
    //   docxBtn.onclick = async () => {
    //     const payload = { topic: topic.value?.trim(), format: formatSel.value };
    //     if(!payload.topic){ topic.focus(); return; }
    //     let text = out.textContent?.trim();
    //     if(!text) text = await runGeneration(payload);
    //     if(!text) return;
    //
    //     try{
    //       const docx = await waitForDocx();
    //       const { Document, Packer, Paragraph, HeadingLevel, TextRun } = docx;
    //       const children = [];
    //       for (const line of text.split(/\r?\n/)){
    //         if(!line.trim()){ children.push(new Paragraph("")); continue; }
    //         const isH3 = /^#{3}\s+/.test(line.trim());
    //         const content = isH3 ? line.replace(/^#{3}\s+/, "") : line;
    //         children.push(isH3
    //           ? new Paragraph({ text: content, heading: HeadingLevel.HEADING_3 })
    //           : new Paragraph({ children: [ new TextRun({ text: content }) ] })
    //         );
    //       }
    //       const doc = new Document({ sections: [{ properties: {}, children }] });
    //       const blob = await Packer.toBlob(doc);
    //       const fname = `MHC_${(payload.topic || 'document').replace(/[^a-z0-9]+/gi,'_')}.docx`;
    //       downloadBlob(blob, fname);
    //     }catch(err){
    //       downloadBlob(new Blob([text], {type: "text/plain;charset=utf-8"}), "MHC_document.txt");
    //       alert("DOCX export failed or was blocked. A .txt file was downloaded instead.\n\nReason: " + err.message);
    //     }
    //   };
    // }
  </script>
</body>
</html>
